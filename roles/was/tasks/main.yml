- name: Install system packages
  yum:
    name:
      - python3
      - python3-pip
    state: present

- name: Create WAS app directory
  file:
    path: /opt/was/app
    state: directory
    owner: ansible
    group: ansible
    mode: '0755'

- name: Copy WAS application files
  copy:
    src: app/
    dest: /opt/was/app/
    owner: ansible
    group: ansible

- name: Create Python venv
  command: python3 -m venv /opt/was/venv
  args:
    creates: /opt/was/venv/bin/activate

- name: Install dependencies
  command: /opt/was/venv/bin/pip install -r /opt/was/app/requirements.txt

- name: Copy WAS environment file
  copy:
    src: was.env
    dest: /etc/was.env
    owner: root
    group: root
    mode: '0600'

- name: Install WAS systemd service
  template:
    src: was.service.j2
    dest: /etc/systemd/system/was.service
  notify: restart was

- name: Enable and start WAS service
  systemd:
    name: was
    enabled: yes
    state: started
    daemon_reload: yes
